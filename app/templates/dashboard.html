{% extends 'base.html' %}
{% block content %}
<section class="py-4 text-center text-white bg-00a859 mb-4">
  <h1>Painel</h1>
</section>

<div class="container mb-5">
  <!-- Em Andamento -->
  <section class="mb-4">
    <h2 class="text-00a859">Votações em Andamento</h2>
    <div class="row row-cols-1 row-cols-md-2 g-4 mt-2">
      {% if active_polls %}
        {% for item in active_polls %}
        <div class="col">
          <div class="card h-100 border-success shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="flex-grow-1">
                <h5 class="card-title">{{ item.poll.title }}</h5>
                <p class="card-text text-muted">
                  Vence em {{ item.poll.expiration_date[:10] }}
                </p>
                <span class="badge bg-success mb-2">● Em Andamento</span>
              </div>
              <canvas id="chart-active-{{ loop.index0 }}" style="max-height:200px;"></canvas>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-center text-muted">Não há votações em andamento.</p>
      {% endif %}
    </div>
  </section>

  <!-- Encerradas -->
  <section>
    <h2 class="text-secondary">Votações Encerradas</h2>
    <div class="row row-cols-1 row-cols-md-2 g-4 mt-2">
      {% if expired_polls %}
        {% for item in expired_polls %}
        <div class="col">
          <div class="card h-100 bg-light text-muted shadow-sm">
            <div class="card-body">
              <h5 class="card-title">{{ item.poll.title }}</h5>
              <p class="card-text"><small>Venceu em {{ item.poll.expiration_date[:10] }}</small></p>
              <span class="badge bg-secondary">● Encerrada</span>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-center text-muted">Não há votações encerradas.</p>
      {% endif %}
    </div>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const COLORS = ['#00a859','#ffc107','#17a2b8','#dc3545','#6f42c1','#fd7e14','#20c997'];

    // Gráficos para enquetes ativas
    {% for item in active_polls %}
      const ctxA{{ loop.index0 }} = document.getElementById('chart-active-{{ loop.index0 }}').getContext('2d');
      new Chart(ctxA{{ loop.index0 }}, {
        type: 'pie',
        data: {
          labels: {{ item.chart.labels|tojson }},
          datasets: [{ 
            data: {{ item.chart.data|tojson }},
            backgroundColor: {{ item.chart.labels|tojson }}.map((_,i)=>COLORS[i%COLORS.length])
          }]
        },
        options: {
          plugins: { legend: { position: 'right' } }
        }
      });
    {% endfor %}
  });
</script>
{% endblock %}