{% extends 'base.html' %}
{% block content %}
<section class="py-4 text-center text-white bg-00a859 mb-4">
  <h1>Painel</h1>
</section>

<div class="container">
  <div class="row g-4">
    {% for item in polls %}
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title text-00a859">{{ item.poll.title }}</h5>
          <p class="card-text text-muted">
            Criada em {{ item.poll.created_at[:10] }} &middot;
            Vence em {{ item.poll.expiration_date[:10] }}
          </p>
          <canvas id="chart-{{ loop.index0 }}" style="max-height:300px;"></canvas>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // cores padrão que se repetem se mais opções
    const COLORS = ['#00a859','#ffc107','#17a2b8','#dc3545','#6f42c1','#fd7e14','#20c997'];

    {% for item in polls %}
      // Pega labels e dados originais
      const rawLabels{{loop.index0}} = {{ item.chart.labels | tojson }};
      const rawData{{loop.index0}}   = {{ item.chart.data   | tojson }};

      // Empacota, ordena por data desc
      const zipped{{loop.index0}} = rawLabels{{loop.index0}}.map((lab, i) => ({
        label: lab,
        value: rawData{{loop.index0}}[i]
      })).sort((a,b) => b.value - a.value);

      // Separa de volta em arrays ordenados
      const labels{{loop.index0}} = zipped{{loop.index0}}.map(el => el.label);
      const data{{loop.index0}}   = zipped{{loop.index0}}.map(el => el.value);

      // Configura o canvas
      const ctx{{loop.index0}} = document.getElementById('chart-{{ loop.index0 }}').getContext('2d');
      new Chart(ctx{{loop.index0}}, {
        type: 'pie',
        data: {
          labels: labels{{loop.index0}},
          datasets: [{
            data: data{{loop.index0}},
            backgroundColor: labels{{loop.index0}}.map((_,i)=>COLORS[i % COLORS.length])
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'right',
              labels: {
                font: { family: 'Roboto', size: 14 },
                generateLabels: (chart) => {
                  // gera as legendas com numeração ordinal
                  return chart.data.labels.map((label, i) => ({
                    text: `${i+1}ª ${label}`,
                    fillStyle: chart.data.datasets[0].backgroundColor[i],
                    hidden: false,
                    index: i
                  }));
                }
              }
            },
            tooltip: { bodyFont: { family: 'Roboto' } }
          }
        }
      });
    {% endfor %}
  });
</script>

{% endblock %}
